{% load i18n %}
{% load static %}

<!DOCTYPE html>
<html>
<head>
    <title>SCORM PLAYER</title>
    <!-- Rev 1.0 - Sunday, May 31, 2009 -->
  {% comment %} <script type="text/javascript" src="{% static 'js/api.js' %}"></script> {% endcomment %}
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src=" https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js "></script>
<script src="https://cdn.jsdelivr.net/npm/scorm-again@latest/dist/scorm-again.js"></script>
    <script type="text/javascript">
      function getSettingsFromParams(urlParams) {
        const settings = {
          autocommit: true,
          autocommitSeconds: 30,
          dataCommitFormat: 'json',
          commitRequestDataType: 'application/json;charset=UTF-8',
          autoProgress: false,
          logLevel: 5,
          mastery_override: false,
        };
        
        if (urlParams.get('autocommit') !== null) {
          settings.autocommit = (urlParams.get('autocommit') === 'true');
        }
        if (urlParams.get('autocommitSeconds') !== null) {
          let seconds = parseInt(urlParams.get('autocommitSeconds'));
          if (isNaN(seconds)) {
            seconds = 60; // default
          }
          settings.autocommitSeconds = seconds;
        }
        if (urlParams.get('dataCommitFormat') !== null) {
          const format = urlParams.get('dataCommitFormat');
          if (format !== null) {
            if (format === 'json' || format === 'params' || format === 'flattened') {
              settings.dataCommitFormat = format;
            }
          }
        }
        if (urlParams.get('logLevel') !== null) {
          let level = parseInt(urlParams.get('logLevel'));
          if (isNaN(level) || level < 1 || level > 5) {
            level = 4; // default
          }
          settings.logLevel = level;
        }
      
        return settings;
      }
      
      const urlParams = new URLSearchParams(window.location.search);
      let settings = getSettingsFromParams(urlParams);
      const csrftoken = Cookies.get('csrftoken');

      settings.lmsCommitUrl = '{% url 'save_scorm' %}';
      settings.xhrHeaders = {'X-CSRFToken': csrftoken}

      window.API = new Scorm12API(settings);

      window.API.on('LMSSetValue.cmi.*', function(CMIElement, value) {
        API.storeData(true);
        $('#cmi').
            html('window.API.cmi = ' + JSON.stringify(API.renderCommitCMI(true), null, 2)).
            removeClass('prettyprinted');
      });

      let dataFromLms = { // this data is passed from the LMS
        cmi: {
          core: {
            entry: 'ab-initio',
            student_id: '@jcputney',
            student_name: 'Jonathan Putney',
          }
        }
      };
      if(urlParams.get('existing')) {
        dataFromLms = _.merge(dataFromLms, EXISTING_SCORM12);
      }

      window.API.loadFromJSON(dataFromLms, '');

      var unloaded = false;
      function unloadHandler() {
        if (!unloaded && !API.isTerminated()) {
          API.LMSSetValue('cmi.core.exit', 'suspend'); //Set exit to whatever is needed
          API.LMSCommit(''); //save all data that has already been set
          API.LMSTerminate(''); //close the SCORM API connection properly
          unloaded = true;
          return false;
        }
        return false;
      }

      window.onbeforeunload = unloadHandler;
      window.onunload = unloadHandler;

      $(document).ready(function() {
      });
    </script>
</head>

  <div>
      
      <iframe src="{% static 'courses\BasicCalls\shared\launchpage.html' %}" width="100%"
      height="750px"></iframe>
  </div>

<!--

<iframe src="{% static 'courses\BasicCalls\shared\launchpage.html' %}" width="100%"
            height="750px">

  <p>Your browser does not support iframes.</p>
</iframe>

</body>
-->
</html>
